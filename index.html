<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="stylesheet.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.5/index.global.min.js'></script>
    <script src="index.global.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

    <title>ã¿ã‚“ãªã§ãŒã‚“ã°ã‚‹ADAã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</title>
</head>
<body>
    <div id="background">
        <video id="video" poster="img/background.mp4" webkit-playsinline playsinline muted autoplay loop>
            <source src="img/background.mp4" type="video/mp4">
        </video>
    </div>

    <h1>ã¿ã‚“ãªã§ãŒã‚“ã°ã‚‹ADAã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>

    <div id="calendar"></div>
    <div id='details'></div>
    <div id='board'></div>

    <form id="message-form">
        <input type="text" id="name-input" placeholder="Your name">
        <input type="text" id="message-input" placeholder="Your message">
        <button type="submit">Submit</button>
    </form>

    <script>
        var firebaseConfig = {
            apiKey: "demo",
            authDomain: "demo",
            databaseURL: "demo",
            projectId: "demo",
            storageBucket: "demo",
            messagingSenderId: "demo",
            appId: "demo"
        };
        firebase.initializeApp(firebaseConfig);

        var currentEventId;

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(date) {
            var options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' };
            return date.toLocaleDateString('ja-JP', options);
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»è©³ç´°è¡¨ç¤º
        function displayEventDetails(event, detailsEl) {
            var start = formatDateTime(event.start);
            var end = event.end ? formatDateTime(event.end) : '';
            var details = '<strong>' + event.title + '</strong> <a href="' + event.url + '">ğŸ”—</a><br>';
            details += '<small>' + start + (end ? ' - ' + end : '') + '</small><br><br>';
            details += event.extendedProps.description + '<br><br>';
            if (event.extendedProps.location) {
                details += 'address: ' + event.extendedProps.location + ' <a href="https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(event.extendedProps.location) + '" target="_blank">MAPğŸ”—</a><br>';
            }
            detailsEl.innerHTML = details;
        }

        // æ²ç¤ºæ¿ãƒ»è¡¨ç¤º
        function displayEventBoard(event, boardEl) {
            var boardRef = firebase.database().ref('boards/' + event.id); //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‚ç…§å ´æ‰€
            boardRef.on('value', function(snapshot) { //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‘¼ã³å‡ºã—
                var messages = snapshot.val();
                var html = '';
                for(var key in messages) {
                    html += '<p><strong>' + messages[key].username + '</strong>: ' + messages[key].message + '</p>';
                }
                boardEl.innerHTML = html; //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                boardEl.scrollTop = boardEl.scrollHeight; //ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€ä¸‹éƒ¨è¡¨ç¤º
            });
        }

        // æ²ç¤ºæ¿ãƒ»Firebaseã¸ä¿å­˜
        function postMessage(eventId, username, message) {
            var boardRef = firebase.database().ref('boards/' + eventId);
            var newMessageRef = boardRef.push(); //pushã§æ–°ã—ã„é …ç›®
            newMessageRef.set({ //Firebaseã«ä¿å­˜
                username: username,
                message: message
            });
        }

        // æ²ç¤ºæ¿ãƒ»æ›¸ãè¾¼ã¿ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault(); //æœªå…¥åŠ›é€ä¿¡ã‚¨ãƒ©ãƒ¼
            var nameInput = document.getElementById('name-input');
            var messageInput = document.getElementById('message-input');
            var name = nameInput.value;
            var message = messageInput.value;
            nameInput.value = '';
            messageInput.value = ''; //ã‚¤ãƒ™ãƒ³ãƒˆå¾Œå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            postMessage(currentEventId, name, message); //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿
        });

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var detailsEl = document.getElementById('details');
            var boardEl = document.getElementById('board');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                googleCalendarApiKey: 'demo',
                events:'demo',

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                eventClick: function(info) {
                    try {
                        info.jsEvent.preventDefault(); //ã‚¤ãƒ™ãƒ³ãƒˆURLã«é·ç§»ã—ãªã„
                        displayEventDetails(info.event, detailsEl);
                        displayEventBoard(info.event, boardEl);
                        currentEventId = info.event.id; //æ²ç¤ºæ¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆidç´ã¥ã‘
                    } catch (error) {
                        console.error('An error occurred:', error);
                        detailsEl.innerHTML = 'ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    }
                },

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»è¡¨ç¤ºå®šç¾©
                eventTimeFormat: { hour: 'numeric', minute: '2-digit' }, //ã‚¤ãƒ™ãƒ³ãƒˆã®æ—¥æ™‚è¡¨ç¤ºå½¢å¼
                eventDidMount: (e)=>{ //ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º
                    tippy(e.el, {
                    content: e.event.title,
                    });
                },
            });
            calendar.render(); //ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
        });
    </script>

</body>
</html>
